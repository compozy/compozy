---
title: "Monitoring & Metrics"
description: "Advanced monitoring and observability with OpenTelemetry and Prometheus for Compozy systems"
---

Compozy provides comprehensive monitoring and observability capabilities using OpenTelemetry and Prometheus for tracking workflow execution, system performance, and operational health.

## Related Documentation

### ðŸ”— Cross-References
- **[MCP Overview](/docs/core/mcp/mcp-overview)** - Understanding MCP architecture  
- **[Production Deployment](/docs/core/mcp/production-deployment)** - Production setup and monitoring
- **[Storage Backends](/docs/core/mcp/storage-backends)** - Storage performance monitoring
- **[Development & Debugging](/docs/core/mcp/development-debugging)** - Development monitoring
- **[Admin API](/docs/core/mcp/admin-api)** - Administrative monitoring endpoints

<Callout type="info">
**What Compozy Monitoring Provides:**
- **OpenTelemetry metrics** with Prometheus exporter
- **System health metrics** (CPU, memory, goroutines)
- **Workflow execution metrics** and performance tracking
- **Custom business metrics** registration and collection
- **HTTP middleware instrumentation** for request/response metrics
- **Temporal workflow metrics** for distributed execution tracking
</Callout>

## Overview

**What it does:** Compozy's monitoring system provides enterprise-grade observability using OpenTelemetry standards with Prometheus-compatible metrics export for comprehensive system monitoring.

**How it works:** The monitoring system uses OpenTelemetry's metrics provider with Prometheus exporters to collect, process, and expose metrics at a configurable endpoint (/metrics by default).

## Monitoring Architecture

The monitoring system is built on industry-standard observability tools:

### OpenTelemetry Integration

Compozy uses OpenTelemetry for metrics collection and export:

```go
// Monitoring service initialization
service, err := monitoring.NewMonitoringService(ctx, config)

// Get OpenTelemetry meter for custom metrics
meter := service.Meter()

// Expose Prometheus-compatible metrics endpoint
http.Handle("/metrics", service.ExporterHandler())
```

### Core Components

1. **Metrics Provider**: OpenTelemetry SDK with Prometheus exporter
2. **Registry**: Prometheus registry for metric collection
3. **Exporters**: HTTP endpoint exposing metrics in Prometheus format
4. **Instrumentation**: Automatic and custom metric collection

## Configuration

### Basic Configuration

Enable monitoring in your Compozy configuration:

```yaml
# compozy.yaml
monitoring:
  enabled: true
  path: "/metrics"
```

### Environment Variables

Override configuration with environment variables:

```bash
export MONITORING_ENABLED=true
export MONITORING_PATH=/metrics
```

### Configuration Options

```yaml
monitoring:
  # Enable/disable metrics collection
  enabled: true
  
  # Metrics endpoint path
  path: "/metrics"
```

## Available Metrics

### System Metrics

Automatically collected system health metrics:

- **CPU usage** - System and process CPU utilization
- **Memory usage** - Heap, stack, and garbage collection metrics  
- **Goroutines** - Active goroutine count and lifecycle
- **Network connections** - Active connections and connection pool stats

### Workflow Metrics

Performance metrics for workflow execution:

- **Execution duration** - Time to complete workflows and tasks
- **Execution count** - Number of workflows executed
- **Error rates** - Failed execution counts and error types
- **Queue depth** - Pending workflow and task counts

### HTTP Metrics

Request/response metrics from HTTP middleware:

- **Request count** - Total HTTP requests by method and status
- **Request duration** - Response time percentiles
- **Request size** - Request and response body sizes
- **Active connections** - Concurrent HTTP connections

### Temporal Metrics

Distributed workflow metrics via Temporal integration:

- **Activity execution** - Activity duration and success rates
- **Workflow lifecycle** - Start, completion, and failure metrics
- **Task queue metrics** - Queue depth and processing times
- **Worker health** - Worker status and capacity metrics

## Metrics Endpoint

### Accessing Metrics

The metrics endpoint exposes Prometheus-formatted metrics:

```bash
# Default endpoint
curl http://localhost:5001/metrics

# Custom endpoint (if configured)
curl http://localhost:5001/internal/metrics
```

### Sample Output

```text
# HELP compozy_workflows_executed_total Total number of workflows executed
# TYPE compozy_workflows_executed_total counter
compozy_workflows_executed_total{status="success"} 1547
compozy_workflows_executed_total{status="failed"} 23

# HELP compozy_workflow_duration_seconds Workflow execution duration in seconds
# TYPE compozy_workflow_duration_seconds histogram
compozy_workflow_duration_seconds_bucket{le="0.1"} 145
compozy_workflow_duration_seconds_bucket{le="0.5"} 892
compozy_workflow_duration_seconds_bucket{le="1"} 1234
compozy_workflow_duration_seconds_bucket{le="5"} 1456
compozy_workflow_duration_seconds_bucket{le="10"} 1547
compozy_workflow_duration_seconds_bucket{le="+Inf"} 1570

# HELP compozy_http_requests_total Total number of HTTP requests
# TYPE compozy_http_requests_total counter
compozy_http_requests_total{method="GET",status="200"} 8934
compozy_http_requests_total{method="POST",status="200"} 2156
compozy_http_requests_total{method="POST",status="400"} 45
```

## Prometheus Integration

### Prometheus Configuration

Configure Prometheus to scrape Compozy metrics:

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'compozy'
    static_configs:
      - targets: ['localhost:5001']
    metrics_path: '/metrics'
    scrape_interval: 15s
```

### Grafana Dashboards

Key metrics to monitor in Grafana:

#### System Health
- CPU and memory usage over time
- Goroutine count trends
- Error rate by service

#### Workflow Performance
- Workflow execution rate (executions/minute)
- Average execution duration
- Success vs failure ratio
- Queue depth and processing lag

#### HTTP Performance
- Request rate and latency percentiles
- Status code distribution
- Response time by endpoint

## Custom Metrics

### Creating Custom Metrics

Add domain-specific metrics using the OpenTelemetry meter:

```go
// Get the meter from monitoring service
meter := monitoringService.Meter()

// Create a counter for custom events
eventCounter, err := meter.Int64Counter(
    "compozy.custom.events.total",
    metric.WithDescription("Total number of custom events"),
)

// Record events
eventCounter.Add(ctx, 1, metric.WithAttributes(
    attribute.String("event_type", "user_action"),
    attribute.String("action", "login"),
))
```

### Metric Types

Available OpenTelemetry metric types:

- **Counter** - Monotonically increasing values (requests, errors)
- **Gauge** - Values that can go up and down (memory, connections)
- **Histogram** - Distribution of values (latency, sizes)

## Production Setup

### Security Considerations

```yaml
# Restrict metrics endpoint access
monitoring:
  enabled: true
  path: "/internal/metrics"  # Non-standard path
```

Use reverse proxy to control access:

```nginx
# nginx.conf
location /internal/metrics {
    # Restrict to monitoring networks
    allow 10.0.0.0/8;
    deny all;
    
    proxy_pass http://compozy_backend;
}
```

### High Availability

For HA deployments, configure each instance:

```yaml
monitoring:
  enabled: true
  path: "/metrics"
```

Add instance labels to distinguish metrics:

```go
// Add instance-specific labels
meter.Int64Counter(
    "compozy.instance.requests",
    metric.WithAttributes(
        attribute.String("instance", os.Getenv("INSTANCE_ID")),
        attribute.String("region", os.Getenv("AWS_REGION")),
    ),
)
```

### Alerting Rules

Example Prometheus alerting rules:

```yaml
# alerts.yml
groups:
  - name: compozy
    rules:
      - alert: CompozyHighErrorRate
        expr: rate(compozy_workflows_executed_total{status="failed"}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: High workflow failure rate detected
          
      - alert: CompozyHighLatency
        expr: histogram_quantile(0.95, compozy_workflow_duration_seconds) > 30
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: Workflow execution latency is high
```

## Troubleshooting

### Common Issues

1. **Metrics endpoint not accessible**
   ```bash
   # Check if monitoring is enabled
   curl http://localhost:5001/health
   
   # Verify configuration
   compozy config show --section monitoring
   ```

2. **No metrics being collected**
   ```bash
   # Check monitoring service status
   curl http://localhost:5001/metrics | grep compozy_
   
   # Enable debug logging
   export LOG_LEVEL=debug
   ```

3. **High memory usage**
   - Monitor metrics cardinality
   - Avoid high-cardinality labels
   - Configure metric retention policies

### Debug Mode

Enable debug logging for monitoring:

```bash
export LOG_LEVEL=debug
compozy start
```

Debug output shows:
- Metrics registration
- Collection intervals
- Export operations
- Error details

## Best Practices

### Metric Design
1. **Use consistent naming** - Follow Prometheus conventions
2. **Avoid high cardinality** - Limit label combinations
3. **Include relevant context** - Add meaningful labels
4. **Monitor the monitoring** - Track metrics system health

### Performance
1. **Collection frequency** - Balance detail vs overhead
2. **Retention policies** - Configure appropriate data retention
3. **Aggregation rules** - Pre-aggregate frequently queried metrics
4. **Resource limits** - Set memory limits for metrics collection

### Operations
1. **Regular review** - Audit metrics for relevance
2. **Alert fatigue** - Tune alerting thresholds
3. **Dashboard maintenance** - Keep dashboards current
4. **Documentation** - Document custom metrics and their meaning

## Next Steps

<FeatureCardList cols={2}>
  <FeatureCard title="Production Deployment" href="/docs/core/mcp/production-deployment">
    Learn about production deployment strategies
  </FeatureCard>
  <FeatureCard title="Development & Debugging" href="/docs/core/mcp/development-debugging">
    Debug and troubleshoot with monitoring data
  </FeatureCard>
  <FeatureCard title="Storage Backends" href="/docs/core/mcp/storage-backends">
    Configure and monitor storage performance
  </FeatureCard>
  <FeatureCard title="Admin API" href="/docs/core/mcp/admin-api">
    Administrative endpoints and operations
  </FeatureCard>
</FeatureCardList>