---
title: Flow Control
description: Control workflow execution with router tasks, conditional logic, and dynamic routing patterns
---

Flow control tasks enable sophisticated workflow routing and conditional execution patterns. Router tasks and conditional logic allow workflows to adapt dynamically based on data, results, and business rules, creating intelligent and responsive automation.

## Overview

Flow control in Compozy provides:

- **Router Tasks**: Conditional branching based on dynamic expressions
- **Conditional Execution**: Skip or modify tasks based on runtime conditions
- **Dynamic Routing**: Route to different task chains based on data
- **Decision Points**: Implement complex business logic in workflows
- **Error Routing**: Intelligent error handling and recovery paths
- **State-Based Routing**: Route based on workflow or task state

<Callout type="info">
Flow control tasks are essential for creating adaptive workflows that can handle different scenarios and business rules automatically.
</Callout>

## Router Tasks

### Basic Router Task

Router tasks evaluate conditions and route execution to different paths:

```yaml
id: document-classifier
type: router
condition: "{{ .tasks.analyze_document.output.document_type }}"

routes:
  invoice: process-invoice
  contract: process-contract
  receipt: process-receipt
  report: process-report

# Default route when no condition matches
default: manual-review

on_error:
  next: handle-routing-error
```

### Advanced Router Patterns

<Tabs items={["Complex Conditions", "Multi-Factor Routing", "Dynamic Routes", "Nested Routing"]}>
<Tab value="Complex Conditions">

Use complex expressions for sophisticated routing logic:

```yaml
id: user-onboarding-router
type: router
condition: |
  {{
    $user := .tasks.get_user.output
    $profile := .tasks.get_profile.output

    if (and (eq $user.account_type "premium") (gt $user.tenure_days 30))
      "premium_user"
    else if (and (eq $user.account_type "basic") (lt $profile.completion_score 0.5))
      "incomplete_profile"
    else if (eq $user.verification_status "pending")
      "pending_verification"
    else if (gt $user.risk_score 0.8)
      "high_risk_user"
    else
      "standard_user"
  }}

routes:
  premium_user: premium-onboarding-flow
  incomplete_profile: profile-completion-flow
  pending_verification: verification-flow
  high_risk_user: risk-assessment-flow
  standard_user: standard-onboarding-flow

default: error-handling-flow
```

</Tab>
<Tab value="Multi-Factor Routing">

Route based on multiple factors simultaneously:

```yaml
id: content-moderation-router
type: router

# Multiple condition evaluation
condition: |
  {{
    $content := .tasks.analyze_content.output
    $user := .tasks.get_user_context.output
    $sentiment := .tasks.sentiment_analysis.output

    $risk_factors := list

    if (gt $content.toxicity_score 0.8)
      $risk_factors = append $risk_factors "high_toxicity"
    end

    if (contains $content.detected_languages "spam_keywords")
      $risk_factors = append $risk_factors "spam_detected"
    end

    if (lt $user.reputation_score 0.3)
      $risk_factors = append $risk_factors "low_reputation"
    end

    if (eq $sentiment.classification "very_negative")
      $risk_factors = append $risk_factors "negative_sentiment"
    end

    if (gt (len $risk_factors) 2)
      "high_risk_content"
    else if (gt (len $risk_factors) 0)
      "moderate_risk_content"
    else
      "safe_content"
  }}

routes:
  high_risk_content: immediate-block-flow
  moderate_risk_content: human-review-flow
  safe_content: auto-approve-flow

default: manual-review-flow
```

</Tab>
<Tab value="Dynamic Routes">

Generate routes dynamically based on data:

```yaml
id: dynamic-workflow-router
type: router

# Dynamic routing based on workflow configuration
condition: |
  {{
    $workflow_config := .tasks.load_workflow_config.output
    $user_permissions := .tasks.check_permissions.output

    $available_paths := list

    # Check each possible path
    range $path, $config := $workflow_config.paths
      if (contains $user_permissions.allowed_paths $path)
        $available_paths = append $available_paths $path
      end
    end

    # Select optimal path based on user context
    $user_context := .tasks.get_user_context.output

    if (contains $available_paths "express_path")
      if (gt $user_context.priority_score 0.8)
        "express_path"
      end
    end

    if (contains $available_paths "standard_path")
      "standard_path"
    end

    if (contains $available_paths "basic_path")
      "basic_path"
    end

    "fallback_path"
  }}

# Routes are also dynamic
routes: |
  {{
    $routes := dict
    $workflow_config := .tasks.load_workflow_config.output

    range $path, $config := $workflow_config.paths
      $routes = set $routes $path $config.target_task
    end

    $routes
  }}

default: error-path
```

</Tab>
<Tab value="Nested Routing">

Implement nested routing for complex decision trees:

```yaml
id: nested-routing-example
type: router
condition: "{{ .tasks.initial_assessment.output.category }}"

routes:
  financial: financial-sub-router
  legal: legal-sub-router
  technical: technical-sub-router

---

id: financial-sub-router
type: router
condition: |
  {{
    $financial_data := .tasks.financial_analysis.output
    $amount := $financial_data.amount
    $complexity := $financial_data.complexity_score

    if (and (gt $amount 100000) (gt $complexity 0.8))
      "high_value_complex"
    else if (gt $amount 100000)
      "high_value_simple"
    else if (gt $complexity 0.8)
      "low_value_complex"
    else
      "standard_processing"
  }}

routes:
  high_value_complex: senior-analyst-review
  high_value_simple: automated-processing
  low_value_complex: specialist-review
  standard_processing: standard-workflow

---

id: legal-sub-router
type: router
condition: |
  {{
    $legal_data := .tasks.legal_analysis.output
    $jurisdiction := $legal_data.jurisdiction
    $complexity := $legal_data.legal_complexity

    if (in $jurisdiction ["US", "EU", "UK"])
      if (gt $complexity 0.7)
        "regulated_complex"
      else
        "regulated_simple"
      end
    else
      "international_review"
  }}

routes:
  regulated_complex: legal-expert-review
  regulated_simple: compliance-check
  international_review: international-legal-team

default: general-legal-review
```

</Tab>
</Tabs>

## Conditional Execution

### Task-Level Conditions

Control individual task execution with conditions:

```yaml
id: conditional-processing
type: basic
$use: agent(local::agents.#(id=="processor"))
action: process_data

# Execute only if condition is met
condition: "{{ and (.workflow.input.enable_processing) (gt .workflow.input.priority 5) }}"

with:
  data: "{{ .workflow.input.data }}"

on_success:
  next: post-processing

# Skip to different task if condition not met
on_skip:
  next: alternative-processing
```

### Conditional Task Chains

Create conditional task sequences:

```yaml
id: user-verification-flow
type: basic
$use: agent(local::agents.#(id=="verifier"))
action: verify_user

with:
  user_id: "{{ .workflow.input.user_id }}"

on_success:
  # Conditional next task based on verification result
  next: |
    {{
      $verification := .output
      if (eq $verification.status "verified")
        if (eq $verification.risk_level "low")
          "instant-approval"
        else
          "additional-checks"
        end
      else if (eq $verification.status "partial")
        "request-additional-info"
      else
        "verification-failed"
      end
    }}
```

### Conditional Workflows

Build entire conditional workflow patterns:

```yaml
id: adaptive-content-pipeline
type: basic
$use: agent(local::agents.#(id=="content-analyzer"))
action: analyze_content

with:
  content: "{{ .workflow.input.content }}"

outputs:
  analysis: "{{ .output }}"

on_success:
  next: content-router

---

id: content-router
type: router
condition: |
  {{
    $analysis := .tasks.adaptive-content-pipeline.outputs.analysis
    $content_type := $analysis.content_type
    $quality_score := $analysis.quality_score
    $audience := $analysis.target_audience

    if (eq $content_type "video")
      if (gt $quality_score 0.8)
        "high_quality_video"
      else
        "video_enhancement"
      end
    else if (eq $content_type "article")
      if (in $audience ["technical", "professional"])
        "technical_article"
      else
        "general_article"
      end
    else if (eq $content_type "social")
      "social_media_processing"
    else
      "generic_content"
  }}

routes:
  high_quality_video: video-publishing-flow
  video_enhancement: video-improvement-flow
  technical_article: technical-review-flow
  general_article: editorial-review-flow
  social_media_processing: social-optimization-flow
  generic_content: standard-processing-flow

default: manual-review-flow
```

## Advanced Flow Control Patterns

### State-Based Routing

Route based on workflow or system state:

```yaml
id: state-aware-router
type: router

# Access workflow state for routing decisions
condition: |
  {{
    $workflow_state := .workflow.state
    $task_history := .workflow.completed_tasks
    $current_load := .system.current_load

    if (contains $task_history "high_priority_task")
      if (lt $current_load 0.7)
        "fast_track"
      else
        "queued_processing"
      end
    else if (gt (len $task_history) 10)
      "long_running_workflow"
    else
      "standard_processing"
  }}

routes:
  fast_track: express-processing
  queued_processing: queue-manager
  long_running_workflow: workflow-optimizer
  standard_processing: normal-flow

# Route based on system state
on_error:
  next: |
    {{
      $system_load := .system.current_load
      if (gt $system_load 0.9)
        "high_load_error_handler"
      else
        "standard_error_handler"
    }}
```

### Error-Aware Routing

Implement sophisticated error handling with routing:

```yaml
id: resilient-router
type: router

# Route based on error patterns
condition: |
  {{
    $error_history := .workflow.error_history
    $current_errors := .tasks.health_check.output.errors

    if (gt (len $error_history) 3)
      "high_error_rate"
    else if (contains $current_errors "timeout")
      "timeout_recovery"
    else if (contains $current_errors "rate_limit")
      "rate_limit_recovery"
    else if (contains $current_errors "auth")
      "auth_recovery"
    else
      "normal_processing"
  }}

routes:
  high_error_rate: error-analysis-flow
  timeout_recovery: retry-with-backoff
  rate_limit_recovery: rate-limit-handler
  auth_recovery: re-authentication-flow
  normal_processing: standard-flow

# Error-specific routing
on_error:
  next: |
    {{
      $error_type := .task.error.type
      $retry_count := .task.retry_count

      if (and (eq $error_type "transient") (lt $retry_count 3))
        "retry_handler"
      else if (eq $error_type "configuration")
        "config_fix_handler"
      else
        "escalation_handler"
    }}
```

### Time-Based Routing

Route based on temporal conditions:

```yaml
id: time-aware-router
type: router

condition: |
  {{
    $now := now
    $hour := $now.Hour
    $weekday := $now.Weekday
    $processing_time := .tasks.estimate_processing.output.estimated_duration

    if (and (ge $hour 9) (le $hour 17) (ne $weekday 0) (ne $weekday 6))
      # Business hours, weekday
      if (lt $processing_time 3600)  # Less than 1 hour
        "business_hours_fast"
      else
        "business_hours_slow"
      end
    else
      # After hours or weekend
      if (lt $processing_time 7200)  # Less than 2 hours
        "off_hours_processing"
      else
        "scheduled_processing"
      end
  }}

routes:
  business_hours_fast: immediate-processing
  business_hours_slow: priority-queue
  off_hours_processing: background-processing
  scheduled_processing: schedule-for-business-hours

default: standard-queue
```

## Real-World Examples

### Example 1: Customer Support Ticket Routing

<Steps>
<Step>

**Initial Analysis**: Analyze incoming support ticket

```yaml
id: analyze-ticket
type: basic
$use: agent(local::agents.#(id=="ticket-analyzer"))
action: analyze_support_ticket

with:
  ticket_content: "{{ .workflow.input.ticket_content }}"
  customer_id: "{{ .workflow.input.customer_id }}"

outputs:
  analysis: "{{ .output }}"

on_success:
  next: customer-context
```

</Step>
<Step>

**Customer Context**: Get customer information for routing

```yaml
id: customer-context
type: basic
$use: tool(local::tools.#(id=="customer-lookup"))

with:
  customer_id: "{{ .workflow.input.customer_id }}"

outputs:
  customer_data: "{{ .output }}"

on_success:
  next: routing-decision
```

</Step>
<Step>

**Routing Decision**: Route ticket based on analysis and context

```yaml
id: routing-decision
type: router

condition: |
  {{
    $analysis := .tasks.analyze-ticket.outputs.analysis
    $customer := .tasks.customer-context.outputs.customer_data

    $urgency := $analysis.urgency_score
    $category := $analysis.category
    $complexity := $analysis.complexity_score
    $customer_tier := $customer.tier
    $customer_satisfaction := $customer.satisfaction_score

    # High priority customers get special treatment
    if (and (eq $customer_tier "premium") (gt $urgency 0.8))
      "premium_urgent"
    else if (and (eq $customer_tier "premium") (lt $customer_satisfaction 0.6))
      "premium_retention"

    # Technical issues routing
    else if (eq $category "technical")
      if (gt $complexity 0.8)
        "technical_expert"
      else
        "technical_standard"
      end

    # Billing issues
    else if (eq $category "billing")
      if (gt $customer.account_value 10000)
        "billing_high_value"
      else
        "billing_standard"
      end

    # General inquiries
    else if (eq $category "general")
      if (lt $complexity 0.3)
        "chatbot_capable"
      else
        "general_support"
      end

    # Complaints
    else if (eq $category "complaint")
      if (gt $urgency 0.7)
        "complaint_urgent"
      else
        "complaint_standard"
      end

    else
      "general_support"
  }}

routes:
  premium_urgent: premium-support-team
  premium_retention: customer-success-team
  technical_expert: senior-technical-team
  technical_standard: technical-support-team
  billing_high_value: billing-specialists
  billing_standard: billing-support-team
  chatbot_capable: automated-response-system
  general_support: general-support-team
  complaint_urgent: complaint-resolution-team
  complaint_standard: customer-care-team

default: general-support-team
```

</Step>
</Steps>

### Example 2: Content Publishing Workflow

```yaml
id: content-publishing-workflow
type: basic
$use: agent(local::agents.#(id=="content-analyzer"))
action: analyze_content

with:
  content: "{{ .workflow.input.content }}"
  metadata: "{{ .workflow.input.metadata }}"

on_success:
  next: publishing-router

---

id: publishing-router
type: router

condition: |
  {{
    $content := .workflow.input.content
    $metadata := .workflow.input.metadata
    $analysis := .tasks.content-publishing-workflow.output

    $content_type := $analysis.content_type
    $quality_score := $analysis.quality_score
    $target_audience := $analysis.target_audience
    $seo_score := $analysis.seo_score
    $compliance_status := $analysis.compliance_status

    # Content must pass compliance first
    if (ne $compliance_status "approved")
      "compliance_review"

    # High-quality content gets fast track
    else if (and (gt $quality_score 0.9) (gt $seo_score 0.8))
      "fast_track_publishing"

    # Video content has special requirements
    else if (eq $content_type "video")
      if (gt $quality_score 0.7)
        "video_processing"
      else
        "video_enhancement"
      end

    # Article content routing
    else if (eq $content_type "article")
      if (in $target_audience ["technical", "professional"])
        "technical_review"
      else if (gt $quality_score 0.8)
        "editorial_review"
      else
        "content_improvement"
      end

    # Social media content
    else if (eq $content_type "social")
      if (gt $quality_score 0.6)
        "social_scheduling"
      else
        "social_optimization"
      end

    # News content has time sensitivity
    else if (eq $content_type "news")
      if (gt $analysis.time_sensitivity 0.8)
        "urgent_news_processing"
      else
        "news_processing"
      end

    else
      "standard_review"
  }}

routes:
  compliance_review: legal-compliance-team
  fast_track_publishing: automated-publishing
  video_processing: video-production-team
  video_enhancement: video-editing-team
  technical_review: technical-editors
  editorial_review: editorial-team
  content_improvement: content-optimization-team
  social_scheduling: social-media-scheduler
  social_optimization: social-media-team
  urgent_news_processing: news-desk-urgent
  news_processing: news-desk-standard
  standard_review: general-editorial-team

default: manual-review-queue
```

### Example 3: E-commerce Order Processing

```yaml
id: order-processing-flow
type: basic
$use: tool(local::tools.#(id=="order-validator"))

with:
  order_data: "{{ .workflow.input.order }}"

outputs:
  validation_result: "{{ .output }}"

on_success:
  next: order-router

---

id: order-router
type: router

condition: |
  {{
    $order := .workflow.input.order
    $validation := .tasks.order-processing-flow.outputs.validation_result

    $order_value := $order.total_amount
    $customer_tier := $order.customer.tier
    $payment_method := $order.payment.method
    $shipping_country := $order.shipping.country
    $item_count := len $order.items
    $validation_status := $validation.status

    # Order validation failed
    if (ne $validation_status "valid")
      if (contains $validation.errors "fraud_risk")
        "fraud_investigation"
      else if (contains $validation.errors "inventory")
        "inventory_check"
      else if (contains $validation.errors "payment")
        "payment_resolution"
      else
        "validation_review"
      end

    # High-value orders get special treatment
    else if (gt $order_value 5000)
      if (eq $customer_tier "vip")
        "vip_high_value"
      else
        "high_value_review"
      end

    # International orders
    else if (not (in $shipping_country ["US", "CA"]))
      if (gt $order_value 1000)
        "international_high_value"
      else
        "international_standard"
      end

    # Bulk orders
    else if (gt $item_count 10)
      "bulk_order_processing"

    # Premium customers
    else if (eq $customer_tier "premium")
      "premium_processing"

    # Digital products
    else if (eq $order.product_type "digital")
      "digital_fulfillment"

    # Standard processing
    else
      "standard_processing"
  }}

routes:
  fraud_investigation: fraud-analysis-team
  inventory_check: inventory-management
  payment_resolution: payment-support-team
  validation_review: order-review-team
  vip_high_value: vip-concierge-service
  high_value_review: high-value-order-team
  international_high_value: international-specialist-team
  international_standard: international-processing
  bulk_order_processing: bulk-order-team
  premium_processing: premium-fulfillment
  digital_fulfillment: digital-delivery-system
  standard_processing: standard-fulfillment

default: manual-review-queue

# Additional error routing
on_error:
  next: |
    {{
      $error := .task.error
      if (eq $error.type "system_overload")
        "queue_management"
      else if (eq $error.type "integration_failure")
        "integration_recovery"
      else
        "error_escalation"
    }}
```

## Best Practices

### Effective Routing Strategies

1. **Keep Conditions Simple**: Use clear, readable conditions
2. **Provide Default Routes**: Always include fallback paths
3. **Document Complex Logic**: Comment complex routing decisions
4. **Test Edge Cases**: Ensure all routing paths are tested
5. **Monitor Route Usage**: Track which routes are used most frequently

### Performance Considerations

```yaml
# Optimize condition evaluation
id: optimized-router
type: router

# Cache expensive operations
condition: |
  {{
    $user_data := .tasks.get_user.output  # Cache this
    $permissions := .tasks.check_permissions.output  # Cache this

    # Use cached values in conditions
    if (and (eq $user_data.tier "premium") (contains $permissions.roles "admin"))
      "admin_premium"
    else
      "standard"
  }}

routes:
  admin_premium: admin-flow
  standard: standard-flow
```

### Error Handling

```yaml
id: robust-router
type: router

condition: |
  {{
    # Safe navigation with null checks
    $analysis := .tasks.analyze_data.output
    if (not $analysis)
      "error_no_analysis"
    else if (not $analysis.result)
      "error_no_result"
    else
      $analysis.result.category
  }}

routes:
  error_no_analysis: handle-missing-analysis
  error_no_result: handle-missing-result
  category_a: process-category-a
  category_b: process-category-b

default: handle-unknown-category

# Comprehensive error handling
on_error:
  next: routing-error-handler
  with:
    routing_condition: "{{ .condition }}"
    available_routes: "{{ .routes }}"
    error_details: "{{ .task.error }}"
```

Flow control tasks enable sophisticated workflow routing and decision-making, creating adaptive and intelligent automation that responds appropriately to different scenarios and business conditions.

## CLI Commands

### Configuration Management
```bash
# View flow control and routing configuration
compozy config show

# Validate flow control task definitions and routing logic
compozy config validate

# Run diagnostics for flow control system health
compozy config diagnostics
```

### User Management
```bash
# Create user for flow control development team
compozy auth create-user

# List users with flow control access permissions
compozy auth list-users

# Update user roles for routing system management
compozy auth update-user

# Remove user access from flow control systems
compozy auth delete-user
```

## Related Documentation

<ReferenceCardList>
  <ReferenceCard
    title="Basic Tasks"
    description="Foundation of all task execution and control flow patterns"
    href="/docs/core/tasks/basic-tasks"
    icon="Cog"
  />
  <ReferenceCard
    title="Router Tasks"
    description="Deep dive into conditional routing and decision logic"
    href="/docs/core/tasks/router-tasks"
    icon="GitBranch"
  />
  <ReferenceCard
    title="Composite Tasks"
    description="Sequential task grouping with conditional execution"
    href="/docs/core/tasks/composite-tasks"
    icon="Layers"
  />
  <ReferenceCard
    title="Advanced Patterns"
    description="Sophisticated orchestration patterns for complex workflows"
    href="/docs/core/tasks/advanced-patterns"
    icon="Network"
  />
</ReferenceCardList>

## Next Steps

<ReferenceCardList>
  <ReferenceCard
    title="Collection Tasks"
    description="Apply flow control patterns to array processing and iteration"
    href="/docs/core/tasks/collection-tasks"
    icon="List"
  />
  <ReferenceCard
    title="Signal Tasks"
    description="Event-driven coordination and inter-workflow communication"
    href="/docs/core/tasks/signal-tasks"
    icon="Radio"
  />
  <ReferenceCard
    title="Business Workflow Examples"
    description="Real-world flow control implementations and patterns"
    href="/docs/core/examples/business-workflows"
    icon="Building"
  />
  <ReferenceCard
    title="Error Handling"
    description="Robust error handling and recovery flow patterns"
    href="/docs/core/workflow/error-handling"
    icon="AlertTriangle"
  />
</ReferenceCardList>
