---
title: "YAML Template Overview"
description: "Understanding Compozy's YAML template engine for dynamic configuration and data flow"
---

# YAML Template Overview

Compozy's YAML template engine is a powerful system that enables dynamic configuration and data flow throughout your workflows. It combines standard YAML syntax with Go template expressions, Sprig function library, and custom directives to create flexible, reusable configurations.

## What are YAML Templates?

YAML templates in Compozy allow you to:

- **Inject dynamic values** from context data, environment variables, and task outputs
- **Reference other resources** using `$ref` and `$use` directives  
- **Apply transformations** using Sprig functions and custom filters
- **Create conditional logic** for routing and decision making
- **Build reusable configurations** that adapt to different contexts

## Template Expression Syntax

Template expressions use Go template syntax wrapped in double curly braces:

```yaml
# Basic value injection
city: "{{ .workflow.input.city }}"

# With transformation
timestamp: "{{ now | date '2006-01-02' }}"

# Conditional logic
route: '{{ .status | eq "success" | ternary "continue" "retry" }}'
```

## Core Features

### Context Variables
Access data from various sources in your templates:

```yaml
# Workflow input
location: "{{ .workflow.input.location }}"

# Task outputs
weather: "{{ .tasks.weather_check.output.temperature }}"

# Environment variables
api_key: "{{ .env.OPENAI_API_KEY }}"

# Collection iteration
item_id: "{{ .item.id }}"
index: "{{ .index }}"
```

### Resource References
Use directives to reference and compose resources:

```yaml
# Reference a schema
input:
  $ref: local::schemas.#(id=="user_input")

# Use a tool
$use: tool(local::tools.#(id=="weather_tool"))

# Reference external agents
$use: agent(resource::agent::#(id=="classifier"))
```

### Sprig Functions
Leverage the full Sprig function library for data manipulation:

```yaml
# String operations
name: "{{ .user.name | title }}"
slug: "{{ .title | lower | replace ' ' '-' }}"

# Array operations
total: "{{ len .items }}"
first_item: "{{ first .items }}"

# Date/time operations
expires: "{{ now | dateModify '+24h' }}"
formatted: "{{ .timestamp | date '2006-01-02 15:04:05' }}"

# Conditional operations
status: "{{ .error | empty | ternary 'success' 'failed' }}"
```

## Template Processing

The template engine processes your YAML configurations in multiple phases:

1. **Parse Phase**: YAML structure is parsed and template expressions are identified
2. **Context Resolution**: Context data is gathered from workflow state, environment, etc.
3. **Template Rendering**: Go templates are executed with the context data
4. **Type Conversion**: Results are converted to appropriate types (strings, numbers, objects)
5. **Reference Resolution**: `$ref` and `$use` directives are resolved to actual resources

## Use Cases

### Dynamic Task Configuration
```yaml
- id: api_call
  type: basic
  $use: tool(local::tools.#(id=="http_request"))
  with:
    url: "{{ .env.API_BASE_URL }}/users/{{ .workflow.input.user_id }}"
    method: "{{ .workflow.input.method | default 'GET' }}"
    headers:
      Authorization: "Bearer {{ .env.API_TOKEN }}"
```

### Conditional Routing
```yaml
- id: result_router
  type: router
  condition: '{{ .tasks.validation.output.valid | ternary "success" "failure" }}'
  routes:
    success:
      $ref: local::tasks.#(id="process_success")
    failure:
      $ref: local::tasks.#(id="handle_error")
```

### Collection Processing
```yaml
- id: process_items
  type: collection
  items: "{{ .workflow.input.data_items }}"
  task:
    id: "process-{{ .index }}"
    type: basic
    $use: tool(local::tools.#(id=="data_processor"))
    with:
      item: "{{ .item }}"
      batch_id: "{{ .workflow.id }}_{{ .index }}"
```

### Agent Instructions
```yaml
instructions: |
  You are a helpful assistant for {{ .workflow.input.domain }}.
  Current context: {{ .tasks.context.output | toJson }}
  
  User query: {{ .workflow.input.query }}
  Available tools: {{ .tools | keys | join ", " }}
```

## Security Considerations

The template engine includes comprehensive security features designed to prevent common vulnerabilities and ensure safe processing of user input.

### XSS Prevention

Compozy provides three essential escaping functions to prevent Cross-Site Scripting (XSS) attacks:

#### HTML Content Escaping
Use `htmlEscape` when rendering user input in HTML content:

```yaml
# Safe HTML rendering
user_message: "{{ .user_input | htmlEscape }}"

# Example: Input "<script>alert('XSS')</script>"
# Output: "&lt;script&gt;alert('XSS')&lt;/script&gt;"
```

#### HTML Attribute Escaping
Use `htmlAttrEscape` when inserting user data into HTML attributes:

```yaml
# Safe HTML attribute rendering
user_profile: |
  <div class="user-card" 
       data-name="{{ .user.name | htmlAttrEscape }}"
       title="{{ .user.bio | htmlAttrEscape }}">
    {{ .user.display_name | htmlEscape }}
  </div>

# Example: Input 'John" onclick="alert(\'XSS\')'
# Output: 'John&quot; onclick=&quot;alert(&#39;XSS&#39;)'
```

#### JavaScript String Escaping
Use `jsEscape` when embedding data in JavaScript contexts:

```yaml
# Safe JavaScript variable assignment
user_data_script: |
  <script>
    var userName = '{{ .user.name | jsEscape }}';
    var userBio = '{{ .user.bio | jsEscape }}';
    var preferences = {{ .user.preferences | toJson | jsEscape }};
  </script>

# Example: Input "'; alert('XSS'); var x='"
# Output: "\'; alert(\'XSS\'); var x\u003D\'"
```

### Input Sanitization Patterns

Implement comprehensive input sanitization for different data types:

```yaml
# Sanitize and validate email addresses
safe_email: |
  {{ if and .user.email (contains .user.email "@") }}
    {{ .user.email | htmlEscape }}
  {{ else }}
    invalid-email@example.com
  {{ end }}

# Sanitize numeric inputs
safe_port: |
  {{ $port := .config.port | int }}
  {{ if and (gt $port 0) (lt $port 65536) }}
    {{ $port }}
  {{ else }}
    3000
  {{ end }}

# Sanitize file paths
safe_filename: |
  {{ .upload.filename | 
     replace "../" "" | 
     replace "./" "" | 
     replace "\\" "" | 
     htmlEscape }}
```

### Security Best Practices

#### 1. Always Escape User Input
```yaml
# ❌ DANGEROUS: Direct user input
dangerous_output: "{{ .user_input }}"

# ✅ SAFE: Properly escaped user input
safe_output: "{{ .user_input | htmlEscape }}"
```

#### 2. Context-Aware Escaping
```yaml
# HTML context
html_content: |
  <div class="message">
    {{ .user_message | htmlEscape }}
  </div>

# HTML attribute context
html_with_attrs: |
  <input type="text" 
         value="{{ .user_input | htmlAttrEscape }}"
         placeholder="{{ .placeholder | htmlAttrEscape }}">

# JavaScript context
js_context: |
  <script>
    var config = {
      message: '{{ .user_message | jsEscape }}',
      data: {{ .user_data | toJson | jsEscape }}
    };
  </script>
```

#### 3. Validate Before Processing
```yaml
# Validate data types before template processing
validated_config: |
  {{ if and .config.timeout (kindIs "float64" .config.timeout) }}
    {{ .config.timeout | int }}
  {{ else }}
    30
  {{ end }}

# Validate array lengths
safe_array_access: |
  {{ if and .items (gt (len .items) 0) }}
    {{ index .items 0 | htmlEscape }}
  {{ else }}
    No items available
  {{ end }}
```

### Template Injection Prevention

Prevent template injection attacks by validating template syntax:

```yaml
# Safe template processing with validation
safe_template_processing: |
  {{ $safeValue := .user_input | htmlEscape }}
  {{ if not (contains $safeValue "{{") }}
    {{ $safeValue }}
  {{ else }}
    [FILTERED: Template syntax detected]
  {{ end }}
```

### Environment-Based Security

Implement different security levels based on environment:

```yaml
# Development vs Production security
security_config: |
  {{ if eq .env.NODE_ENV "development" }}
    <!-- Development mode: Show debug info -->
    Debug: {{ .debug_info | htmlEscape }}
  {{ else }}
    <!-- Production mode: Limited information -->
    Status: {{ .status | htmlEscape }}
  {{ end }}
```

## Performance Features

The template engine is designed for high-performance processing with several optimization features:

### Template Caching

The engine automatically caches parsed templates to avoid repeated compilation:

```yaml
# Templates are parsed once and cached by name
cached_template: |
  {{ range .items }}
    - {{ .name | title }}: {{ .value }}
  {{ end }}
```

**Cache Behavior:**
- Templates are cached by their content hash
- Cache is thread-safe with `sync.RWMutex`
- Cache persists for the lifetime of the `TemplateEngine` instance
- No automatic cache eviction - suitable for long-running services

### Concurrent Safety

The template engine is fully thread-safe for concurrent workflow processing:

```yaml
# Multiple workflows can safely process templates concurrently
concurrent_processing: |
  Workflow {{ .workflow.id }} processed at {{ now }}
  Result: {{ .tasks.parallel_task.output | toJson }}
```

**Thread Safety Features:**
- `sync.RWMutex` protects template cache and global values
- Multiple goroutines can safely call `RenderString` simultaneously
- Read operations use read locks for optimal performance
- Write operations (cache updates) use exclusive locks

### Performance Optimization Tips

#### 1. Minimize Template Complexity
```yaml
# ❌ SLOW: Complex nested operations
slow_template: "{{ range .items }}{{ if eq .type 'valid' }}{{ .name | upper | replace ' ' '_' | trimSuffix '_item' }}{{ end }}{{ end }}"

# ✅ FAST: Simple, clear operations
fast_template: |
  {{ range .items }}
    {{ if eq .type 'valid' }}
      {{ .name | upper | replace ' ' '_' | trimSuffix '_item' }}
    {{ end }}
  {{ end }}
```

#### 2. Cache Expensive Operations
```yaml
# Cache results of expensive operations
optimized_processing: |
  {{ $processedItems := .items | processExpensiveOperation }}
  {{ range $processedItems }}
    Item: {{ .name }}
  {{ end }}
```

#### 3. Use Lazy Evaluation
```yaml
# Templates are only processed when values are accessed
lazy_evaluation: |
  {{ if .should_process }}
    {{ .expensive_operation | complexTransformation }}
  {{ else }}
    {{ .simple_value }}
  {{ end }}
```

### Memory Usage Patterns

The template engine optimizes memory usage through several techniques:

#### Type Preservation
```yaml
# Numeric precision is maintained
numeric_precision: |
  Price: {{ .product.price }}        # Preserves decimal precision
  Quantity: {{ .product.quantity }}  # Maintains integer type
```

#### Object Reference Optimization
```yaml
# Simple object references avoid unnecessary string conversion
object_reference: "{{ .tasks.api_call.output }}"  # Preserves object structure
filtered_reference: "{{ .tasks.api_call.output | toJson }}"  # Converts to JSON string
```

### Performance Monitoring

Monitor template performance in production:

```yaml
# Add performance debugging
performance_debug: |
  {{ $start := now }}
  {{ .complex_template_operation }}
  <!-- Processing time: {{ sub (now | unixEpoch) ($start | unixEpoch) }}ms -->
```

### Benchmarking Examples

Example performance characteristics:

```yaml
# Template compilation: ~1ms for typical templates
# Template rendering: ~0.1ms for simple templates
# Cache hit rate: >95% in typical workflow scenarios
# Memory usage: ~1KB per cached template
# Concurrent throughput: 10,000+ renders/second
```

## Next Steps

Build your template expertise progressively:

### Foundation
- **[YAML Basics](./yaml-basics)**: Learn fundamental YAML syntax and structure
- **[Template Directives](./directives)**: Master resource references with `$ref` and `$use`

### Core Skills  
- **[Context Variables](./context-variables)**: Understand available data sources and access patterns
- **[Sprig Functions](./sprig-functions)**: Transform and manipulate data with powerful functions
  - **[Security Functions](./sprig-functions#compozy-specific-security-functions)**: Prevent XSS and injection attacks
  - **[Performance Optimization](./sprig-functions#performance-optimization)**: Write efficient, scalable templates

### Advanced Techniques
- **[Advanced Patterns](./advanced-patterns)**: Complex template scenarios and dynamic configurations
- **[Validation and Debugging](./validation-debugging)**: Troubleshoot issues and ensure quality

### Integration
- **[Task Configuration](../tasks/basic-tasks)**: Use templates in task definitions
- **[Agent Instructions](../agents/instructions-actions)**: Dynamic agent behavior with templates
- **[Workflow Orchestration](../configuration/workflows)**: Template-driven workflow management
