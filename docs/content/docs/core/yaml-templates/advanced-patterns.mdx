---
title: "Advanced Patterns"
description: "Sophisticated template techniques for complex workflows and dynamic configurations"
---

Advanced template patterns enable sophisticated workflows, dynamic configurations, and complex data transformations in Compozy. This guide covers techniques for building powerful, maintainable template-driven systems.

## Prerequisites

<Callout type="info">
  Before exploring advanced patterns, ensure you understand [Sprig Functions](./sprig-functions) for data manipulation and [Context Variables](./context-variables) for data access patterns.
</Callout>

## Dynamic Resource Selection

Dynamic resource selection allows runtime decision-making based on context, conditions, and environment variables.

<Tabs items={["Tool Selection", "Agent Selection", "Environment Config"]}>
<Tab>
**Dynamic tool selection** adapts to input types and conditions:

```yaml
# Runtime tool selection based on data type
- id: process_data
  type: basic
  $use: |
    {{- $data_type := .workflow.input.data_type -}}
    {{- if eq $data_type "image" -}}
      tool(local::tools.#(id=="image_processor"))
    {{- else if eq $data_type "text" -}}
      tool(local::tools.#(id=="text_processor"))
    {{- else -}}
      tool(local::tools.#(id=="generic_processor"))
    {{- end -}}
  with:
    input_data: "{{ .workflow.input.data }}"
    processor_config: "{{ .workflow.input.config }}"
```

**Use cases**: Multi-format data processing, conditional tool chains, adaptive workflows.
</Tab>

<Tab>
**Dynamic agent selection** chooses specialized agents based on complexity or domain:

```yaml
# Agent selection based on query complexity and domain
- id: analyze_query
  type: basic
  $use: |
    {{- $complexity := .tasks.assess_complexity.output.score -}}
    {{- $domain := .workflow.input.domain -}}
    {{- if and (gt $complexity 8) (eq $domain "legal") -}}
      agent(resource::agent::#(id=="legal_expert_advanced"))
    {{- else if eq $domain "legal" -}}
      agent(resource::agent::#(id=="legal_assistant"))
    {{- else if gt $complexity 6 -}}
      agent(resource::agent::#(id=="general_expert"))
    {{- else -}}
      agent(resource::agent::#(id=="general_assistant"))
    {{- end -}}
```

**Decision factors**: Domain expertise, complexity scores, user permissions, resource availability.
</Tab>

<Tab>
**Environment-based configuration** adapts to deployment contexts:

```yaml
# Environment-specific model selection
model_config: |
  {{- $env := .env.DEPLOYMENT_ENV | default "development" -}}
  {{- if eq $env "production" -}}
    global::models.#(tier=='premium' && provider=='openai')
  {{- else if eq $env "staging" -}}
    global::models.#(tier=='standard' && provider=='groq')
  {{- else -}}
    global::models.#(tier=='basic' && provider=='ollama')
  {{- end -}}
```

**Environment patterns**: Production vs. development configs, region-specific resources, cost optimization.
</Tab>
</Tabs>

## Template Composition

Template composition enables reusable, maintainable configurations through fragments and inheritance.

<Tabs items={["Reusable Fragments", "Template Inheritance", "Data Transformation"]}>
<Tab>
**Reusable fragments** create modular template components:

```yaml
# Define reusable template fragments
fragments:
  - id: auth_headers
    template: |
      Authorization: "Bearer {{ .env.API_TOKEN }}"
      X-Client-ID: "{{ .env.CLIENT_ID }}"
      X-Request-ID: "{{ .workflow.id }}"
      
  - id: error_response
    template: |
      {
        "error": true,
        "message": "{{ .error_message | htmlEscape }}",
        "timestamp": "{{ now | date '2006-01-02T15:04:05Z' }}",
        "request_id": "{{ .workflow.id }}"
      }

# Use fragments in tasks
- id: api_call
  type: basic
  $use: tool(local::tools.#(id=="http_client"))
  with:
    headers:
      $template: "{{ .fragments.auth_headers }}"
    error_handler:
      $template: "{{ .fragments.error_response }}"
```

**Benefits**: Reduced duplication, consistent patterns, easier maintenance.
</Tab>

<Tab>
**Template inheritance** builds complex templates from simpler ones:

```yaml
# Base notification template
base_notification: |
  Dear {{ .user.name | default "User" }},
  
  {{ .message | htmlEscape }}
  
  Best regards,
  The {{ .env.APP_NAME | default "Compozy" }} Team

# Extended notification with action
action_notification: |
  {{ template "base" . }}
  
  To take action, click: {{ .action_url | urlquery }}
  
  This link expires on {{ .expires_at | date "January 2, 2006" }}.

# Usage in task
- id: send_notification
  type: basic
  with:
    email_body: |
      {{- $data := merge .workflow.input .tasks.get_user.output -}}
      {{- template "action_notification" $data -}}
```

**Inheritance patterns**: Base templates, specialized extensions, data merging.
</Tab>

<Tab>
**Complex data transformation** reshapes and processes data structures:

```yaml
# Transform array of objects with validation
transformed_data: |
  {{- $users := .tasks.get_users.output.users -}}
  {{- $result := list -}}
  {{- range $user := $users -}}
    {{- if and $user.email $user.name -}}
      {{- $transformed := dict 
          "id" $user.id
          "full_name" (printf "%s %s" $user.first_name $user.last_name)
          "contact" (dict 
            "email" ($user.email | lower | trim)
            "phone" ($user.phone | default "N/A"))
          "status" ($user.is_active | ternary "active" "inactive")
          "join_date" ($user.created_at | date "2006-01-02")
      -}}
      {{- $result = append $result $transformed -}}
    {{- end -}}
  {{- end -}}
  {{ $result | toJson }}

# Aggregate metrics from multiple sources
aggregated_metrics: |
  {{- $performance := .tasks.get_performance.output -}}
  {{- $usage := .tasks.get_usage.output -}}
  {{- $errors := .tasks.get_errors.output -}}
  
  {{- $summary := dict
      "total_requests" (add $performance.requests $usage.api_calls)
      "avg_response_time" (div (add $performance.response_time $usage.latency) 2)
      "error_rate" (div (mul $errors.count 100) $performance.requests)
      "uptime_percentage" (sub 100 $errors.downtime_percentage)
  -}}
  {{ $summary | toPrettyJson }}
```

**Transformation patterns**: Data validation, aggregation, restructuring, type conversion.
</Tab>
</Tabs>

## State Machine Patterns

State machine patterns implement workflow state management and complex business logic with event-driven transitions.

**Core State Machine Pattern**:

```yaml
# Unified state management with approval chains and conditional processing
- id: business_state_manager
  type: router
  condition: |
    {{- $state := .tasks.get_state.output.state -}}
    {{- $event := .workflow.input.event -}}
    {{- $amount := .workflow.input.amount -}}
    {{- $department := .workflow.input.department -}}
    
    # State transition logic with business rules
    {{- if eq $state "pending" -}}
      {{- if eq $event "approve" -}}
        {{- if gt $amount 10000 -}}requires_cfo_approval
        {{- else -}}approved{{- end -}}
      {{- else if eq $event "reject" -}}rejected
      {{- else -}}pending{{- end -}}
    {{- else if eq $state "requires_cfo_approval" -}}
      {{- if eq $event "cfo_approve" -}}
        {{- if gt $amount 50000 -}}requires_ceo_approval
        {{- else -}}approved{{- end -}}
      {{- else -}}{{ $state -}}{{- end -}}
    {{- else if eq $state "approved" -}}
      {{- if eq $event "process" -}}processing
      {{- else -}}approved{{- end -}}
    {{- else -}}{{ $state -}}{{- end -}}
  routes:
    approved:
      - id: process_approval
        with:
          approval_chain: |
            {{- $approvers := list "department_head" -}}
            {{- if gt .workflow.input.amount 10000 -}}{{ $approvers = append $approvers "cfo" }}{{- end -}}
            {{- if gt .workflow.input.amount 50000 -}}{{ $approvers = append $approvers "ceo" }}{{- end -}}
            {{ $approvers | toJson }}
          enhanced_data: |
            {{- $order := .workflow.input -}}
            {{- $priority := ternary "high" "standard" (gt $order.amount 1000) -}}
            {{- $shipping := ternary "express" "ground" (eq $order.customer.tier "premium") -}}
            {{ merge $order (dict "priority" $priority "shipping" $shipping) | toJson }}
```

**Key techniques**: Event-driven transitions, business rule integration, hierarchical approval flows.

## Dynamic Workflow Generation

Dynamic workflow generation creates adaptive workflows based on runtime conditions.

**Core Pattern - Dynamic Task Creation**:

```yaml
# Unified pattern for dynamic task generation and processing
- id: dynamic_processor
  type: collection
  items: "{{ .workflow.input.data_sources }}"
  task:
    id: "process-{{ .index }}"
    type: basic
    $use: |
      {{- $type := .item.type | default "generic" -}}
      tool(local::tools.#(id=="{{$type}}_processor"))
    with:
      source_url: "{{ .item.url }}"
      credentials: "{{ .item.credentials }}"
      # Resource-aware batch size
      batch_size: |
        {{- if gt (.system.cpu | default 4) 8 -}}50
        {{- else if gt (.system.cpu | default 4) 4 -}}25
        {{- else -}}10{{- end -}}
```

**Key techniques**: Data-driven task creation, conditional resource allocation, parallel processing optimization.

## Advanced Error Handling

Comprehensive error handling with retry logic, validation, and circuit breaker patterns.

**Unified Error Handling Pattern**:

```yaml
# Resilient operation with comprehensive error handling
- id: resilient_processor
  type: basic
  $use: tool(local::tools.#(id=="api_client"))
  with:
    # Input validation
    validated_input: |
      {{- $input := .workflow.input -}}
      {{- $errors := list -}}
      {{- if not $input.email -}}{{ $errors = append $errors "Email required" }}{{- end -}}
      {{- if and $input.age (or (lt ($input.age | int) 0) (gt ($input.age | int) 150)) -}}
        {{- $errors = append $errors "Invalid age range" -}}
      {{- end -}}
      {{- dict "valid" (empty $errors) "errors" $errors "data" $input | toJson -}}
    
    # Circuit breaker with retry logic
    execution_config: |
      {{- $failures := .metrics.failures | default 0 -}}
      {{- $attempt := .task.attempt | default 1 -}}
      {{- if gt $failures 10 -}}
        {"circuit": "open", "fallback": true}
      {{- else if .task.error -}}
        {
          "circuit": "closed",
          "retry": {{ lt $attempt 3 }},
          "delay": {{ mul $attempt 5 }},
          "url": "{{ ternary .env.BACKUP_API_URL .env.PRIMARY_API_URL (gt $attempt 2) }}",
          "timeout": {{ mul (.config.timeout | default 30) $attempt }}
        }
      {{- else -}}
        {"circuit": "closed", "url": "{{ .env.PRIMARY_API_URL }}"}
      {{- end -}}
```

**Key techniques**: Input validation, progressive backoff, circuit breaker states, fallback URLs, timeout scaling.

## Performance Optimization

Essential techniques for efficient template rendering:

**Core Performance Pattern**:

```yaml
# Optimized template with caching and conditional loading
optimized_processing: |
  {{- $timestamp := now | date "2006-01-02T15:04:05Z" -}}
  {{- $batch_size := 50 -}}
  
  # Only process if needed
  {{- if .workflow.input.process_data -}}
    {{- range $i, $item := .data.collection | batch $batch_size -}}
    batch_{{ $i }}:
      timestamp: {{ $timestamp }}  # Reuse computed value
      items: {{ len $item }}
      data: {{ $item | toJson }}
    {{- end -}}
  {{- else -}}
    {"status": "skipped", "timestamp": "{{ $timestamp }}"}
  {{- end -}}
```

**Key techniques**: Variable reuse, conditional processing, batch optimization.

## Best Practices

Key principles for maintainable advanced templates.

<Tabs items={["Modular Design", "Error-First", "Documentation"]}>
<Tab>
**Modular template design** promotes reusability:

```yaml
# Break complex templates into modules
user_module:
  profile: "{{ template 'user_profile' . }}"
  permissions: "{{ template 'user_permissions' . }}"
  preferences: "{{ template 'user_preferences' . }}"

# Reusable security patterns
security_module:
  headers: "{{ template 'security_headers' . }}"
  validation: "{{ template 'input_validation' . }}"
  escaping: "{{ template 'output_escaping' . }}"
```

**Modular benefits**: Easier testing, better maintenance, improved reusability.
</Tab>

<Tab>
**Error-first design** considers failure cases:

```yaml
# Always handle errors first
safe_operation: |
  {{- if .errors -}}
    {{ template 'error_response' . }}
  {{- else if .validation_failed -}}
    {{ template 'validation_error' . }}
  {{- else -}}
    {{ template 'success_response' . }}
  {{- end -}}

# Defensive programming patterns
defensive_template: |
  {{- $data := .workflow.input -}}
  {{- if not $data -}}
    {"error": "No input data provided"}
  {{- else if not $data.required_field -}}
    {"error": "Required field missing"}
  {{- else -}}
    {{- template 'process_data' $data -}}
  {{- end -}}
```

**Error-first patterns**: Validation first, graceful degradation, clear error messages.
</Tab>

<Tab>
**Documentation in templates** explains complex logic:

```yaml
# Document complex template logic
complex_logic: |
  {{- /* 
  This template calculates user priority based on:
  1. Account tier (premium = +10, standard = +5, basic = +0)
  2. Activity score (scaled 0-10)
  3. Support history (penalties for excessive tickets)
  */ -}}
  
  {{- $base_score := .user.tier | tierToScore -}}
  {{- $activity_score := .user.activity | scaleToTen -}}
  {{- $support_penalty := .user.support_tickets | calculatePenalty -}}
  
  {{ add $base_score $activity_score | sub $support_penalty }}

# Type-safe configurations
type_safe_config: |
  {{- $config := dict -}}
  {{- $config = set $config "port" (.env.PORT | default "3000" | int) -}}
  {{- $config = set $config "debug" (.env.DEBUG | default "false" | bool) -}}
  {{- $config = set $config "timeout" (.env.TIMEOUT | default "30.5" | float64) -}}
  {{ $config | toJson }}
```

**Documentation patterns**: Inline comments, type annotations, usage examples.
</Tab>
</Tabs>

## References

<ReferenceCardList>
  <ReferenceCard
    title="Validation & Debugging"
    description="Debug template issues and validate complex patterns"
    href="/docs/core/yaml-templates/validation-debugging"
    icon="Bug"
  />
  <ReferenceCard
    title="Template Directives"
    description="Use $ref and $use for resource composition"
    href="/docs/core/yaml-templates/directives"
    icon="Link"
  />
  <ReferenceCard
    title="Basic Tasks"
    description="Apply advanced patterns to basic task configurations"
    href="/docs/core/tasks/basic-tasks"
    icon="Play"
  />
  <ReferenceCard
    title="Agent Instructions"
    description="Use advanced templates in agent instructions and actions"
    href="/docs/core/agents/instructions-actions"
    icon="Bot"
  />
</ReferenceCardList>

Advanced template patterns provide the foundation for sophisticated, maintainable Compozy workflows. Focus on modularity, error handling, and performance optimization for production-ready templates.