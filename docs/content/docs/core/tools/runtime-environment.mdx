---
title: "Runtime Environment"
description: "Understand Compozy's secure Bun runtime for executing TypeScript tools with configurable permissions and resource management"
---

## Overview

Compozy uses [Bun](https://bun.sh) as its JavaScript/TypeScript runtime environment, providing a fast, secure, and efficient execution platform for your tools. This guide explains the runtime architecture, security model, and configuration options for production deployments.

<FeatureCardList>
  <FeatureCard
    title="Lightning Fast"
    description="Bun's performance significantly reduces tool startup time and execution overhead"
    icon="Zap"
    size="sm"
  />
  <FeatureCard
    title="TypeScript Native"
    description="Run TypeScript directly without compilation steps or configuration complexity"
    icon="FileCode"
    size="sm"
  />
  <FeatureCard
    title="Secure by Default"
    description="Fine-grained permission system with process isolation for each tool execution"
    icon="Shield"
    size="sm"
  />
  <FeatureCard
    title="Modern APIs"
    description="Support for latest JavaScript features and Web standard APIs out of the box"
    icon="Cpu"
    size="sm"
  />
</FeatureCardList>

## Architecture Overview

### Process Isolation

Each tool execution runs in a separate Bun process, ensuring:

<List>
  <ListItem title="Complete isolation" icon="Shield">Between tool executions for maximum security</ListItem>
  <ListItem title="Memory protection" icon="Lock">Preventing cross-tool data leaks</ListItem>
  <ListItem title="Resource limits" icon="Gauge">Enforced at the process level</ListItem>
  <ListItem title="Clean environment" icon="RefreshCw">For each execution</ListItem>
</List>

### Communication Protocol

Tools communicate through a simple JSON-based protocol:

<Mermaid chart={`
sequenceDiagram
    participant Agent
    participant Runtime as Bun Runtime
    participant Tool as Tool Process
    participant Stdout

    Agent->>Runtime: Send tool request with JSON input
    Runtime->>Tool: Start isolated process
    Runtime->>Tool: Pass JSON via stdin
    
    alt Input validation success
        Tool->>Tool: Parse and validate input
        Tool->>Tool: Execute tool logic
        
        alt Processing success
            Tool->>Stdout: Write JSON result
            Tool->>Runtime: Exit with code 0
            Runtime->>Agent: Return successful result
        else Processing error
            Tool->>Stdout: Write error JSON
            Tool->>Runtime: Exit with code 1
            Runtime->>Agent: Return error result
        end
    else Input validation failure
        Tool->>Stdout: Write validation error JSON
        Tool->>Runtime: Exit with code 1
        Runtime->>Agent: Return validation error
    end
    
    Runtime->>Runtime: Cleanup process resources
`} />

## Security Model

<Callout type="warning">
Security is paramount when executing user-provided code. Compozy implements multiple layers of protection to ensure safe tool execution.
</Callout>

### Permission System

Configure granular permissions for each tool based on its requirements:

#### File System Permissions

Control read and write access to specific directories:

```yaml
runtime:
  permissions:
    - --allow-read=./data        # Read from data directory
    - --allow-write=./output     # Write to output directory
    - --deny-write=/etc          # Explicitly deny system directories
```

<List>
  <ListItem title="Use absolute paths" icon="FolderOpen">For clarity and security</ListItem>
  <ListItem title="Start with minimal permissions" icon="Shield">Follow principle of least privilege</ListItem>
  <ListItem title="Explicitly deny sensitive directories" icon="X">Block access to system directories</ListItem>
</List>

#### Network Permissions

Restrict network access to specific domains:

```yaml
runtime:
  permissions:
    - --allow-net=api.example.com     # Specific domain
    - --allow-net=*.trusted.com       # Wildcard subdomain
    - --allow-net=192.168.1.0/24      # IP range
```

<Callout type="info">
Always specify exact domains rather than allowing all network access
</Callout>

#### Environment Variables

Control which environment variables tools can access:

```yaml
runtime:
  permissions:
    - --allow-env=API_KEY,API_SECRET  # Specific variables
    - --allow-env=NODE_*              # Pattern matching
```

<List>
  <ListItem title="Only expose required variables" icon="Eye">Minimal environment access</ListItem>
  <ListItem title="Use patterns for related variable groups" icon="Group">Organize with wildcards when appropriate</ListItem>
  <ListItem title="Never expose system environment wholesale" icon="EyeOff">Avoid broad environment access</ListItem>
</List>

### Resource Limits

Prevent resource exhaustion with configurable limits:

<Tabs items={["Memory Limits", "Timeout Configuration", "Output Constraints"]}>
  <Tab value="Memory Limits">
    ```yaml
    runtime:
      limits:
        memory: "256MB"    # Maximum heap size

    # Per-tool override
    tools:
      heavy-processor:
        runtime:
          limits:
            memory: "1GB"  # Higher limit for specific tool
    ```

    Recommended limits by use case:
    - Simple tools: 128MB - 256MB
    - Data processing: 512MB - 1GB
    - Heavy computation: 1GB - 2GB
  </Tab>

  <Tab value="Timeout Configuration">
    ```yaml
    runtime:
      limits:
        timeout: "30s"     # Default timeout

    # Context-aware timeouts
    tools:
      api-client:
        timeout: "60s"     # Network operations need more time
      file-processor:
        timeout: "5m"      # Large file processing
    ```

    Set timeouts based on:
    - Expected operation duration
    - Network latency considerations
    - Data processing complexity
  </Tab>

  <Tab value="Output Constraints">
    ```yaml
    runtime:
      limits:
        output_size: "10MB"   # Maximum output size

    # Prevent memory attacks
    tools:
      report-generator:
        runtime:
          limits:
            output_size: "50MB"  # Larger reports allowed
    ```

    Output size considerations:
    - JSON serialization overhead
    - Network transfer limits
    - Agent context window constraints
  </Tab>
</Tabs>

## Configuration Patterns

<Tabs items={["Development Environment", "Production Environment", "High-Security Environment"]}>
  <Tab value="Development Environment">
    Optimized for rapid iteration and debugging:

    ```yaml
    # compozy.yaml (development)
    runtime:
      type: bun
      entrypoint: "./tools/index.ts"

      permissions:
        - --allow-read       # Permissive for development
        - --allow-net        # All network access
        - --allow-env        # All environment variables

      limits:
        memory: "512MB"
        timeout: "60s"
        output_size: "20MB"

      debug:
        enabled: true
        log_level: "debug"
    ```

    **Key Features:**
    <FeatureCardList cols={2} size="sm">
      <FeatureCard
        title="Permissive permissions"
        description="For faster development iteration"
        icon="Unlock"
      />
      <FeatureCard
        title="Higher resource limits"
        description="For debugging and development needs"
        icon="Gauge"
      />
      <FeatureCard
        title="Debug mode enabled"
        description="With detailed logging output"
        icon="Bug"
      />
      <FeatureCard
        title="All access allowed"
        description="Network and environment variables"
        icon="Globe"
      />
    </FeatureCardList>
  </Tab>

  <Tab value="Production Environment">
    Locked down with minimal required permissions:

    ```yaml
    # compozy.yaml (production)
    runtime:
      type: bun
      entrypoint: "./dist/tools/index.js"

      permissions:
        - --allow-read=./data
        - --allow-net=api.production.com
        - --allow-env=API_KEY,API_SECRET

      limits:
        memory: "256MB"
        timeout: "30s"
        output_size: "5MB"

      security:
        strict_mode: true
        validate_schemas: true
        log_access: true
    ```

    **Key Features:**
    <FeatureCardList cols={2} size="sm">
      <FeatureCard
        title="Minimal permissions"
        description="Following least privilege principle"
        icon="Shield"
      />
      <FeatureCard
        title="Optimized resource limits"
        description="For production workloads"
        icon="Zap"
      />
      <FeatureCard
        title="Strict security mode"
        description="With schema validation"
        icon="Lock"
      />
      <FeatureCard
        title="Access logging enabled"
        description="For audit trails"
        icon="FileText"
      />
    </FeatureCardList>
  </Tab>

  <Tab value="High-Security Environment">
    Maximum restrictions for sensitive operations:

    ```yaml
    # compozy.yaml (high-security)
    runtime:
      type: bun
      entrypoint: "./tools/secure.js"

      permissions:
        - --allow-read=/app/data/public
        - --allow-net=internal-api.local:443
        - --allow-env=TOOL_CONFIG
        - --deny-write=*              # No write access

      limits:
        memory: "128MB"
        timeout: "10s"
        output_size: "1MB"

      security:
        strict_mode: true
        validate_schemas: true
        log_all_operations: true
        audit_mode: true
    ```

    **Key Features:**
    <FeatureCardList cols={2} size="sm">
      <FeatureCard
        title="Maximum security restrictions"
        description="With explicit denials"
        icon="ShieldCheck"
      />
      <FeatureCard
        title="Minimal resource limits"
        description="To prevent resource attacks"
        icon="AlertTriangle"
      />
      <FeatureCard
        title="Comprehensive logging"
        description="And audit mode enabled"
        icon="Activity"
      />
      <FeatureCard
        title="No write access"
        description="To prevent data modification"
        icon="ShieldX"
      />
    </FeatureCardList>
  </Tab>
</Tabs>

## Best Practices

<AccordionGroup>
  <Accordion title="Security Best Practices">
    <List>
      <ListItem title="Principle of Least Privilege" icon="Shield">Only grant permissions absolutely required</ListItem>
      <ListItem title="Validate All Inputs" icon="CheckCircle">Use JSON Schema validation before processing</ListItem>
      <ListItem title="Sanitize File Paths" icon="FileX">Prevent directory traversal attacks</ListItem>
      <ListItem title="Limit Network Domains" icon="Globe">Explicitly list allowed external services</ListItem>
      <ListItem title="Monitor Resource Usage" icon="Activity">Set alerts for unusual consumption patterns</ListItem>
      <ListItem title="Regular Security Audits" icon="Search">Review tool permissions periodically</ListItem>
    </List>
  </Accordion>

  <Accordion title="Performance Optimization">
    <List>
      <ListItem title="Appropriate Limits" icon="Gauge">Set realistic memory and timeout values</ListItem>
      <ListItem title="Connection Pooling" icon="Link2">Reuse HTTP connections where possible</ListItem>
      <ListItem title="Efficient Data Handling" icon="Database">Stream large datasets instead of loading entirely</ListItem>
      <ListItem title="Cache Results" icon="Archive">Implement caching for expensive operations</ListItem>
      <ListItem title="Profile Performance" icon="BarChart3">Use Bun's built-in profiler in development</ListItem>
    </List>
  </Accordion>

  <Accordion title="Development Workflow">
    <List>
      <ListItem title="Start Permissive" icon="Unlock">Begin with relaxed permissions in development</ListItem>
      <ListItem title="Gradually Restrict" icon="Lock">Tighten permissions as you understand requirements</ListItem>
      <ListItem title="Test Limits" icon="TestTube">Verify tools work within production constraints</ListItem>
      <ListItem title="Document Requirements" icon="FileText">Note why each permission is needed</ListItem>
      <ListItem title="Version Control" icon="GitBranch">Track permission changes in your repository</ListItem>
    </List>
  </Accordion>
</AccordionGroup>

## Tool Implementation Patterns

<Tabs items={["Basic Tool Structure", "Environment Variable Access", "Error Handling"]}>
  <Tab value="Basic Tool Structure">
    Every tool follows this pattern for reliable execution:

    ```typescript
    import { z } from 'zod';

    // Define input/output schemas
    const inputSchema = z.object({
      data: z.array(z.unknown()),
      operation: z.string()
    });

    const outputSchema = z.object({
      result: z.unknown(),
      metadata: z.object({
        processed: z.number(),
        duration: z.number()
      })
    });

    // Type definitions
    type Input = z.infer<typeof inputSchema>;
    type Output = z.infer<typeof outputSchema>;

    // Main function
    export async function processData(input: Input): Promise<Output> {
      const start = Date.now();

      // Validate input
      const validated = inputSchema.parse(input);

      // Process data
      const result = await performOperation(validated);

      // Return validated output
      return outputSchema.parse({
        result,
        metadata: {
          processed: validated.data.length,
          duration: Date.now() - start
        }
      });
    }
    ```

    **Key Elements:**
    <FeatureCardList cols={2} size="sm">
      <FeatureCard
        title="Zod schemas"
        description="For input/output validation"
        icon="Shield"
      />
      <FeatureCard
        title="Type-safe interfaces"
        description="With TypeScript"
        icon="Code"
      />
      <FeatureCard
        title="Performance tracking"
        description="With execution timing"
        icon="Clock"
      />
      <FeatureCard
        title="Structured metadata"
        description="In responses"
        icon="FileJson"
      />
    </FeatureCardList>
  </Tab>

  <Tab value="Environment Variable Access">
    Tools can safely access configured environment variables:

    ```typescript
    // Safe environment access pattern
    function getRequiredEnv(name: string): string {
      const value = process.env[name];
      if (!value) {
        throw new Error(`Required environment variable ${name} is not set`);
      }
      return value;
    }

    // Optional environment variables with defaults
    function getOptionalEnv(name: string, defaultValue: string): string {
      return process.env[name] || defaultValue;
    }

    // Usage in tool
    export async function apiClient(input: ApiInput): Promise<ApiOutput> {
      const apiKey = getRequiredEnv('API_KEY');
      const baseUrl = getRequiredEnv('API_BASE_URL');
      const timeout = parseInt(getOptionalEnv('API_TIMEOUT', '30000'));

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);

      try {
        const response = await fetch(`${baseUrl}/${input.endpoint}`, {
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          signal: controller.signal
        });

        return await response.json();
      } finally {
        clearTimeout(timeoutId);
      }
    }
    ```

    **Best Practices:**
    <FeatureCardList cols={2} size="sm">
      <FeatureCard
        title="Always validate required variables"
        description="Environment variable validation"
        icon="CheckCircle"
      />
      <FeatureCard
        title="Provide sensible defaults"
        description="For optional variables"
        icon="Settings"
      />
      <FeatureCard
        title="Use timeout controls"
        description="For network requests"
        icon="Timer"
      />
      <FeatureCard
        title="Clean up resources"
        description="In finally blocks"
        icon="Trash2"
      />
    </FeatureCardList>
  </Tab>

  <Tab value="Error Handling">
    Implement consistent error handling across all tools:

    ```typescript
    // Structured error response
    interface ToolError {
      success: false;
      error: string;
      code?: string;
      details?: Record<string, any>;
    }

    interface ToolSuccess<T> {
      success: true;
      data: T;
    }

    type ToolResult<T> = ToolSuccess<T> | ToolError;

    // Error handling wrapper
    export function withErrorHandling<T extends unknown[], R>(
      fn: (...args: T) => Promise<R>
    ) {
      return async (...args: T): Promise<ToolResult<R>> => {
        try {
          const result = await fn(...args);
          return { success: true, data: result };
        } catch (error) {
          if (error instanceof z.ZodError) {
            return {
              success: false,
              error: 'Input validation failed',
              code: 'VALIDATION_ERROR',
              details: { issues: error.issues }
            };
          }

          const message = error instanceof Error ? error.message : 'Unknown error occurred';
          return {
            success: false,
            error: message,
            code: 'EXECUTION_ERROR'
          };
        }
      };
    }

    // Usage example
    export const safeDataProcessor = withErrorHandling(processData);
    ```

    **Error Categories:**
    <FeatureCardList cols={2} size="sm">
      <FeatureCard
        title="Validation errors"
        description="From Zod schema failures"
        icon="AlertCircle"
      />
      <FeatureCard
        title="Runtime errors"
        description="From processing logic"
        icon="Bug"
      />
      <FeatureCard
        title="Network errors"
        description="From external API calls"
        icon="Wifi"
      />
      <FeatureCard
        title="Resource errors"
        description="From limits or timeouts"
        icon="Gauge"
      />
    </FeatureCardList>
  </Tab>
</Tabs>

## Performance Optimization

<List>
  <ListItem title="Minimize Dependencies" icon="Package">
    Keep tools lightweight by only importing necessary libraries
  </ListItem>
  <ListItem title="Cache Expensive Operations" icon="Archive">
    Implement caching for repeated expensive computations
  </ListItem>
  <ListItem title="Optimize Algorithms" icon="Zap">
    Profile and optimize hot code paths
  </ListItem>
  <ListItem title="Connection Pooling" icon="Link2">
    Reuse HTTP/database connections across requests
  </ListItem>
  <ListItem title="Async Operations" icon="Split">
    Use concurrent processing where appropriate
  </ListItem>
</List>

## Related Documentation

<ReferenceCardList>
  <ReferenceCard
    title="TypeScript Development"
    description="Learn how to build tools with TypeScript"
    href="/docs/core/tools/typescript-development"
  />
</ReferenceCardList>
