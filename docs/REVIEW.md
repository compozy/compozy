- [ ] In engine/task2/factory.go around lines 164 to 175, the current code silently handles errors from CWD creation by assigning an empty PathCWD{}, which may cause issues later. Modify the function to either return an error alongside the TaskConfigRepository or log a warning message when CWDFromPath fails, ensuring the error is explicitly handled and visible for debugging.

- [ ] In engine/task2/parallel/response_handler.go around lines 111 to 123, the deprecated method ExtractParallelStrategy currently returns a constant StrategyWaitAll, which is misleading. To fix this, either implement the proper extraction logic by delegating to the baseHandler's extractParentStrategy method if accessible, or remove this method entirely if it is no longer needed, or alternatively make it panic with a clear deprecation message to prevent misuse. 

- [ ] In engine/task2/shared/children_context_test.go around lines 293 to 296, replace any direct string conversion of core.ID with the core.ID.String() method to ensure the conversion produces the expected string representation. Locate where core.ID values are converted to strings and update those conversions to use the String() method instead of direct casting or other means. 

- [ ] In engine/task2/shared/context_circular_test.go at lines 293 to 296, replace the direct string conversions of core.ID values with calls to their String() method for proper conversion. Change string(parentExecID) to parentExecID.String() and string(childExecID) to childExecID.String(). Also apply the same fix to lines 355 to 357 where similar conversions occur.

- [ ] In engine/task2/shared/state_repository.go around lines 39 to 44, the parentCache map is accessed concurrently without synchronization, risking race conditions. Add a sync.RWMutex field to DefaultStateRepository to protect cache access. Use the mutex's RLock/RUnlock methods for read operations and Lock/Unlock for write operations around all parentCache accesses, including those in lines 72 to 90, to ensure thread-safe cache operations.

- [ ] In engine/task2/shared/validation.go at line 90, the valid task types map is missing the entry for task.TaskTypeMemory, which is used in exec_memory.go. Add task.TaskTypeMemory to the map with a value of true to ensure it is recognized as a valid task type. 

- [ ] In engine/task2/signal/response_handler.go around lines 82 to 91, the ValidateSignalDispatch method always returns nil regardless of the task status, which does not properly validate signal dispatch success. Update the method to return nil only if state.Status equals core.StatusSuccess, and return an appropriate error if the status indicates failure, ensuring the validation logic matches the comment's intent.

- [ ] In engine/task2/wait/response_handler_test.go around lines 128 to 142, the test comments mention that ValidateWaitCompletion panics when passed a nil state because it accesses state.Status. To fix this, update the ValidateWaitCompletion method to include a nil check at the start of the function. If the state parameter is nil, return an appropriate error such as "state cannot be nil" to prevent panics and handle the nil input gracefully.

- [ ] In engine/task2/core/config_repo.go at lines 89 to 103, the StoreParallelMetadata method currently only checks if metadata is non-nil and of the correct type but does not validate the content such as ensuring ChildConfigs is not empty or strategy values are valid. To fix this, add explicit validation after the type assertion to check that ChildConfigs is not empty and that any strategy fields have acceptable values. Return an error if these validations fail. Apply similar content validation logic to the methods at lines 126-140 and 163-177 as well.

- [ ] In engine/task2/core/config_repo.go around lines 312 to 320, the valid strategies are hardcoded as string literals in the isValidStrategy method. To improve maintainability, replace the hardcoded string slice with a reference to a centralized list or map of strategy constants defined elsewhere in the codebase. This way, the validation will automatically stay up to date when strategies change, avoiding duplication and manual updates.

- [ ] In pkg/tplengine/precision_converter.go around lines 49 to 56, replace the magic numbers -9007199254740991 and 9007199254740991 with named constants for clarity. Define package-level constants JavaScriptMaxSafeInteger and JavaScriptMinSafeInteger with these values, then update the if condition to use these constants instead of the raw numbers.

- [ ] In pkg/tplengine/precision_converter.go around lines 73 to 78, replace the magic number 15 used for the float64 significant digits limit with a named constant. Define a package-level constant named Float64SignificantDigits with a value of 15 and a descriptive comment. Then update the if condition to compare against this constant instead of the raw number 15.

- [ ] In engine/task2/collection/expander.go lines 166 to 189, replace the hardcoded strings "\_collection_item" and "\_collection_index" with the shared constants defined in config_builder.go for collection field names. Import the package where these constants are defined and use those constants instead of string literals to ensure consistency across the codebase.

- [ ] In engine/task2/collection/response_handler.go around lines 150 to 160, the ValidateCollectionOutput method is currently empty and lacks validation logic for collection outputs. Implement appropriate validation based on the expected structure of the collection output, such as checking if the output is non-nil and matches the expected type or format (e.g., an array). If no validation is needed, add a clear comment explaining why to avoid confusion.

- [ ] In engine/task2/determinism_test.go around lines 75 to 99, the test named "Should work with concurrent map access safely" is misleading because it performs sequential calls rather than concurrent map access, so it does not test thread safety. To fix this, either rename the test to "Should maintain deterministic order across multiple sequential calls" to accurately reflect its behavior, or modify the test to perform actual concurrent map access by running the map iteration in multiple goroutines simultaneously and synchronizing their completion to properly test thread safety.

- [ ]  In engine/task2/shared/base_context_builder.go around lines 73 to 83, the type assertions to map[string]any for ctx.Variables["task"] do not handle the case when the assertion fails, which can silently skip updates and hide bugs. Modify the code to check the result of the type assertion and handle the failure case explicitly, such as logging an error or returning an error, to ensure that any issues with the type assertion are detected and addressed.

- [ ] In engine/task2/shared/children_index_builder.go around lines 84 to 87, the code creates a full copy of the visited map for each child, which is unnecessary and can degrade performance. Instead of copying the map, pass the original visited map directly to child calls since the defer statement already removes the current node from the map, ensuring correct cleanup without extra copying. 

- [ ] In engine/task2/shared/parent_status_manager.go around lines 367 to 375, the validateID function only checks if the id is an empty string but does not verify if it is a valid UUID as the comment suggests. To fix this, add proper UUID format validation using a UUID parsing or validation library to ensure the id conforms to UUID standards, returning an error if it does not. This will enhance security by preventing invalid or malicious IDs.

- [ ] In engine/task2/shared/progress_context_builder.go around lines 12 to 35, update the BuildProgressContext function to accept a context.Context parameter as per project guidelines and add nil checks to safely handle cases where the state argument might be nil. Also, ensure to import the context package. Modify the function signature to include context, check if state is nil before accessing its fields, and handle such cases gracefully to avoid panics.

- [ ] In engine/task2/shared/task_output_builder.go around lines 35 to 47, the environment variable name "COMPOZY_MAX_TASK_CONTEXT_DEPTH" is hardcoded inside the function. Extract this string as a package-level constant named EnvMaxTaskContextDepth, and also move the defaultMaxDepth constant to the package level. Then update the function to use these constants instead of hardcoded values for improved maintainability.

- [ ] In engine/workflow/output_transformer.go around lines 34 to 49, the function returns nil when outputsConfig is nil but returns an empty core.Output pointer when outputsConfig is empty, causing inconsistent handling. To fix this, unify the return behavior by either always returning nil or always returning an empty core.Output pointer in both cases, so callers can handle the output consistently regardless of whether outputsConfig is nil or empty. 

- [ ] In go.mod around lines 51 to 52, the testcontainers-go dependencies are included unconditionally, causing large unnecessary dependencies in production builds. Move the github.com/testcontainers/testcontainers-go and its postgres module dependencies into a separate go.mod file or use build constraints to include them only in test builds. This can be done by adding a separate go.mod for tests or using the // +build test directive in test files and importing testcontainers-go only there. After making these changes, run go mod tidy to clean up the module cache and ensure these dependencies are only present for test builds.

- [ ] In test/helpers/database.go around lines 46 to 60, replace the hardcoded time.Sleep(100 \* time.Millisecond) used to wait for connections to close with a proper synchronization mechanism. Implement a loop or use a synchronization primitive to actively check if all connections in the pool are closed before proceeding, ensuring reliable cleanup without arbitrary delays that can cause flaky tests. 
